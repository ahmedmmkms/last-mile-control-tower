<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PWA Installation Test</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f0f2f5;
        }
        .container {
            background: white;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        h1 {
            color: #1976d2;
            text-align: center;
        }
        .test-section {
            margin: 20px 0;
            padding: 15px;
            border-radius: 5px;
        }
        .pass {
            background-color: #e8f5e9;
            border-left: 4px solid #4caf50;
        }
        .fail {
            background-color: #ffebee;
            border-left: 4px solid #f44336;
        }
        .warning {
            background-color: #fff8e1;
            border-left: 4px solid #ff9800;
        }
        .info {
            background-color: #e3f2fd;
            border-left: 4px solid #2196f3;
        }
        button {
            background-color: #1976d2;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 16px;
            margin: 10px 5px;
        }
        button:hover {
            background-color: #1565c0;
        }
        button.secondary {
            background-color: #757575;
        }
        button.secondary:hover {
            background-color: #616161;
        }
        .results {
            margin: 20px 0;
        }
        .result-item {
            padding: 10px;
            margin: 5px 0;
            border-radius: 3px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üîç PWA Installation Test</h1>
        <p>This page tests if your browser supports PWA installation.</p>
        
        <div style="text-align: center;">
            <button onclick="runTests()">Run PWA Tests</button>
            <button class="secondary" onclick="attemptInstall()">Attempt Installation</button>
        </div>
        
        <div id="results" class="results"></div>
        
        <div id="install-section" style="display: none; margin-top: 30px;">
            <h2>üì• Installation</h2>
            <div id="install-message"></div>
            <button onclick="attemptInstall()">Install App</button>
        </div>
    </div>

    <script>
        let deferredPrompt;

        // Capture install prompt
        window.addEventListener('beforeinstallprompt', (e) => {
            console.log('Install prompt captured');
            e.preventDefault();
            deferredPrompt = e;
            document.getElementById('install-section').style.display = 'block';
            document.getElementById('install-message').innerHTML = '<p class="test-section info">‚úÖ App is installable! Click the button below to install.</p>';
        });

        // Handle installation
        window.addEventListener('appinstalled', (evt) => {
            console.log('App installed successfully');
            document.getElementById('install-message').innerHTML = '<p class="test-section pass">üéâ App installed successfully!</p>';
        });

        // Test PWA features
        async function runTests() {
            const results = document.getElementById('results');
            results.innerHTML = '<h2>üìä Test Results</h2>';
            
            const tests = [
                testServiceWorker,
                testManifest,
                testHTTPS,
                testOfflineSupport,
                testInstallability
            ];
            
            let passed = 0;
            
            for (const test of tests) {
                const result = await test();
                if (result.passed) passed++;
                displayResult(result);
            }
            
            results.innerHTML += `
                <div class="test-section" style="background-color: #e0e0e0; border-left: 4px solid #616161;">
                    <strong>Summary: ${passed}/${tests.length} tests passed</strong>
                </div>
            `;
        }

        // Display test result
        function displayResult(result) {
            const results = document.getElementById('results');
            const className = result.passed ? 'pass' : (result.warning ? 'warning' : 'fail');
            const icon = result.passed ? '‚úÖ' : (result.warning ? '‚ö†Ô∏è' : '‚ùå');
            
            results.innerHTML += `
                <div class="test-section ${className}">
                    <strong>${icon} ${result.name}</strong><br>
                    <small>${result.description}</small>
                </div>
            `;
        }

        // Test service worker
        async function testServiceWorker() {
            try {
                if ('serviceWorker' in navigator) {
                    const registration = await navigator.serviceWorker.getRegistration();
                    if (registration) {
                        return {
                            name: 'Service Worker',
                            description: 'Service worker is registered',
                            passed: true
                        };
                    } else {
                        return {
                            name: 'Service Worker',
                            description: 'Service worker not registered',
                            passed: false
                        };
                    }
                } else {
                    return {
                        name: 'Service Worker',
                        description: 'Service worker not supported',
                        passed: false
                    };
                }
            } catch (error) {
                return {
                    name: 'Service Worker',
                    description: `Error: ${error.message}`,
                    passed: false
                };
            }
        }

        // Test manifest
        async function testManifest() {
            try {
                const manifestLink = document.querySelector('link[rel="manifest"]');
                if (!manifestLink) {
                    return {
                        name: 'Web App Manifest',
                        description: 'Missing manifest link tag',
                        passed: false
                    };
                }
                
                const response = await fetch(manifestLink.href);
                if (response.ok) {
                    const manifest = await response.json();
                    if (manifest.name && manifest.short_name && manifest.start_url) {
                        return {
                            name: 'Web App Manifest',
                            description: 'Manifest found and valid',
                            passed: true
                        };
                    } else {
                        return {
                            name: 'Web App Manifest',
                            description: 'Manifest missing required fields',
                            passed: false
                        };
                    }
                } else {
                    return {
                        name: 'Web App Manifest',
                        description: 'Manifest file not accessible',
                        passed: false
                    };
                }
            } catch (error) {
                return {
                    name: 'Web App Manifest',
                    description: `Error: ${error.message}`,
                    passed: false
                };
            }
        }

        // Test HTTPS
        function testHTTPS() {
            const isSecure = location.protocol === 'https:' || 
                           location.hostname === 'localhost' || 
                           location.hostname === '127.0.0.1';
            
            return {
                name: 'HTTPS Connection',
                description: isSecure ? 
                    'Secure connection (HTTPS or localhost)' : 
                    'Not secure - PWA requires HTTPS in production',
                passed: isSecure
            };
        }

        // Test offline support
        function testOfflineSupport() {
            const supportsOffline = 'caches' in window && 'indexedDB' in window;
            
            return {
                name: 'Offline Support',
                description: supportsOffline ? 
                    'Cache API and IndexedDB available' : 
                    'Cache API or IndexedDB not available',
                passed: supportsOffline
            };
        }

        // Test installability
        function testInstallability() {
            // Check for required meta tags
            const viewport = document.querySelector('meta[name="viewport"]');
            const hasViewport = !!viewport;
            
            return {
                name: 'Installability Requirements',
                description: hasViewport ? 
                    'All installability requirements met' : 
                    'Missing viewport meta tag',
                passed: hasViewport,
                warning: !hasViewport
            };
        }

        // Attempt installation
        function attemptInstall() {
            if (deferredPrompt) {
                deferredPrompt.prompt();
                deferredPrompt.userChoice.then((choiceResult) => {
                    if (choiceResult.outcome === 'accepted') {
                        console.log('User accepted the install prompt');
                    } else {
                        console.log('User dismissed the install prompt');
                    }
                    deferredPrompt = null;
                });
            } else {
                // Try to trigger installation manually
                if (window.navigator && window.navigator.getInstalledRelatedApps) {
                    console.log('Checking if app is already installed...');
                }
                
                // Show instructions for manual installation
                showManualInstallInstructions();
            }
        }

        // Show manual installation instructions
        function showManualInstallInstructions() {
            const message = document.getElementById('install-message');
            message.innerHTML = `
                <div class="test-section info">
                    <h3>üì± Manual Installation Instructions</h3>
                    <p><strong>Chrome/Edge (Desktop):</strong></p>
                    <ol>
                        <li>Click the three dots menu (‚ãÆ) in the browser toolbar</li>
                        <li>Select "Install [App Name]" or "Apps" ‚Üí "Manage Apps" ‚Üí "Install this site as an app"</li>
                    </ol>
                    <p><strong>Chrome (Android):</strong></p>
                    <ol>
                        <li>Click the three dots menu (‚ãÆ) in the browser toolbar</li>
                        <li>Select "Add to Home screen"</li>
                    </ol>
                    <p><strong>Safari (iOS):</strong></p>
                    <ol>
                        <li>Tap the Share button (square with arrow)</li>
                        <li>Scroll down and tap "Add to Home Screen"</li>
                    </ol>
                    <p><strong>Firefox:</strong></p>
                    <ol>
                        <li>Click the three lines menu (‚ò∞)</li>
                        <li>Select "Install" or look for PWA installation option</li>
                    </ol>
                </div>
            `;
        }

        // Initialize
        window.addEventListener('load', () => {
            console.log('PWA Installation Test Page Loaded');
            
            // Auto-run tests
            setTimeout(runTests, 1000);
        });
    </script>
</body>
</html>